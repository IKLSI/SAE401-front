<!DOCTYPE html>
<html lang="fr">
    <head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<title>Page de test</title>
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<link rel="stylesheet" type="text/css" href="./nav.css"/>
	</head>
<body>
    <div class="background-left"></div>
		<div class="background-right">
			<select class="form-control"></select>
		</div>
		<div class="background-center"></div>
		<script src="./nav.js"></script>
		<script src="./year.js"></script>
	</body>

    <input type="file" id="fichierExcelInput" accept=".xlsx">
    <button onclick="importerFichier()">Importer</button>
    <div id="resultat"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>
    <script>
        function importerFichier() {
            const input = document.getElementById('fichierExcelInput');
            const fichier = input.files[0];

            if (!fichier) {
                alert("Veuillez sélectionner un fichier Excel.");
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                const enTetesAttendus = ['etudid', 'code_nip', 'Rg', 'Nom', 'Prénom', 'TD', 'TP', 'Cursus', 'Moy', 'Abs'];
                const enTetesFichier = Object.keys(jsonData[0]);

                const enTetesManquants = enTetesAttendus.filter(enTete => !enTetesFichier.includes(enTete));

                if (enTetesManquants.length > 0) {
                    document.getElementById('resultat').innerHTML = "Les en-têtes suivants sont manquants dans le fichier Excel: " + enTetesManquants.join(', ');
                } else {
                    const entetesAssociatifs = {};
                    const enteteModule = [];

                    let enteteBIN = null;
                    enTetesFichier.forEach(enTete => {
                        // Retirer le '_' et tout ce qui vient après
                        const cleanEnTete = enTete.replace(/_.*/, '');
                        if (/^BIN\d/.test(cleanEnTete)) {
                            enteteBIN = cleanEnTete;
                            entetesAssociatifs[enteteBIN] = [];
                        } else if (enteteBIN && (cleanEnTete.startsWith('BINR') || cleanEnTete.startsWith('BINS') || cleanEnTete.startsWith('BINP') || cleanEnTete.startsWith('Bonus') )) {
                            entetesAssociatifs[enteteBIN].push(cleanEnTete);
                            if (!enteteModule.includes(cleanEnTete)) {
                                enteteModule.push(cleanEnTete);
                            }
                        }
                    });

                    ajouterCompetencesEtModules(jsonData, entetesAssociatifs, enteteModule, enTetesAttendus);
					// Ajout des compétences dans la BD
                    
				
                }
            };

            reader.readAsArrayBuffer(fichier);
        }

        async function ajouterCompetencesEtModules(jsonData, entetesAssociatifs, enteteModule, enTetesAttendus) {

            const hmCompetences = {};
            const hmModules = {};
            const hmCoefficient = {};

            try {
                // Récupérer l'ID de la dernière compétence
                const idCompetence = await getMaxCompetenceId();

                // Ajouter chaque compétence dans la base de données
                var cptComp = 1;
                for (const competence in entetesAssociatifs) {
                    const idComp = idCompetence + cptComp;
                    await ajouterCompetence(idComp, competence, 1 /* déterminer l'idSemestre */);
                    hmCompetences[competence] = idComp;
                    cptComp ++;
                }

                // Récupérer l'ID du dernier module
                const idModule = await getMaxModuleId();

                // Ajouter chaque module dans la base de données
                var cptModule = 1;
                for (const module of enteteModule) {
                    if (!module.startsWith('Bonus')) {
                        const idMod = idModule + cptModule;
                        await ajouterModule(idMod, module);
                        hmModules[module] = idMod;
                        cptModule++;
                    }
                }

                // Récupérer l'ID du dernier module
                const idCoeff = await getMaxCoeffId();

                // Ajouter les coefficients dans la base de données
                var cptCoeff = 1;
                for (const competence in entetesAssociatifs) {
                    if (entetesAssociatifs.hasOwnProperty(competence)) {
                        for (const module of entetesAssociatifs[competence]) {
                            if (!module.startsWith('Bonus')) {
                                const idCo = idCoeff + cptCoeff;
                                await ajouterCoefficient(idCo, hmModules[module], hmCompetences[competence]);
                                hmCoefficient[module + "-" + competence] = idCo;
                                cptCoeff++;
                            }
                        }
                    }
                }

            } catch (error) {
                console.error("Une erreur s'est produite :", error);
            }

            ajouterDonnees(jsonData, entetesAssociatifs, enteteModule, enTetesAttendus);
        }

		function ajouterDonnees(jsonData, entetesAssociatifs, enteteModule, entetesObligatoires) {
            let resultat = "";

            // Affichage des entêtes obligatoires et des valeurs pour chaque ligne
            jsonData.forEach(element => {
                const codeEtu = Number(element.etudid)
                // Appeler la méthode pour ajouter l'étudiant
                ajouterEtudiant({
                    code_etu: codeEtu,
                    nom_etu: element.Nom,
                    prenom_etu: element.Prénom,
                    groupe_TD: element.TD,
                    groupe_TP: element.TP,
                    cursus: element.Cursus,
                    alternant: 0 // déterminer cette valeur
                });

                resultat += "<strong>Données pour " + element.Prénom + ":</strong><br>";
                
                // Affichage des entêtes obligatoires
                entetesObligatoires.forEach(entete => {
                    resultat += entete + ": " + element[entete] + "<br>";
                });

                // Affichage des entêtes associatives et de leurs valeurs
               for (const competenceLabel in entetesAssociatifs) {
                    if (entetesAssociatifs.hasOwnProperty(competenceLabel)) {
                        resultat += "<br>" + competenceLabel + ": " + element[competenceLabel] + "<br>";
                        entetesAssociatifs[competenceLabel].forEach(moduleLabel => {
                            resultat += " - " + moduleLabel + ": " + element[moduleLabel] + "<br>";
                            
                             getIdEtudiantByCode(codeEtu)
                            .then(idEtu => {
                                    if (moduleLabel.startsWith("Bonus")) {
                                        const idComp = getIdCompetenceByName(competenceLabel);
                                        ajouterEtuComp(idEtu, idComp, element[competenceLabel], "",element[moduleLabel])
                                    }
                                    else {
                                        
                                        const idCoeff = getIdCoeffByModuleAndComp(getIdModuleByName(moduleLabel), getIdCompetenceByName(competenceLabel))
                                        ajouterEtuModule(idEtu, idCoeff, element[moduleLabel])
                                    }
                                })
                                .catch(error => {
                                    console.error("Une erreur s'est produite :", error);
                                });

                            
                        });
                    }
                   
                }
                resultat += "<br>";
            });

            document.getElementById('resultat').innerHTML = resultat;
        }
		
		async function ajouterEtudiant(data) {
            console.log([data])
            $.ajax({
				url: 'http://localhost:8000/api/addEtudiant',
				type: 'POST',
				dataType: 'json',
				data: JSON.stringify([data]),
				success: function(data) {
					console.log('Success : ');
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log('Erreur : ' + errorThrown);
				}
			});
        }

        async function ajouterEtuModule(idEtu, idCoefficient, note) {
            $.ajax({
				url: 'http://localhost:8000/api/addEtuModule',
				type: 'POST',
				dataType: 'json',
				data: JSON.stringify([{ id_etu: idEtu, id_coef: idCoefficient, note: note }]),
				success: function(data) {
					console.log('Success : ');
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log('Erreur : ' + errorThrown);
				}
			});
        }

        async function ajouterEtuComp(idEtu, idComp, moyenneComp, passage, bonus) {
            $.ajax({
				url: 'http://localhost:8000/api/addEtuComp',
				type: 'POST',
				dataType: 'json',
				data: JSON.stringify([{ id_etu: idEtu, id_comp: idComp, moyenne_comp: moyenneComp, passage: passage, bonus: bonus }]),
				success: function(data) {
					console.log('Success : ');
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log('Erreur : ' + errorThrown);
				}
			});
        }

        async function ajouterModule(idModule, moduleLabel) {
            // Vérifier si le module existe déjà
            const response = await fetch(`http://localhost:8000/api/module/${idModule}`);
            const data = await response.json();
            if (data && Object.keys(data).length !== 0) {
                console.log(`Le module avec l'ID ${idModule} existe déjà.`);
                return;
            }

            // Ajouter le module s'il n'existe pas
            $.ajax({
				url: 'http://localhost:8000/api/addModule',
				type: 'POST',
				dataType: 'json',
				data: JSON.stringify([{ label: moduleLabel }]),
				success: function(data) {
					console.log('Success : ');
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log('Erreur : ' + errorThrown);
				}
			});
        }

        async function ajouterCompetence(idCompetence, competenceLabel, idSemestre) {
            // Vérifier si la compétence existe déjà
            const response = await fetch(`http://localhost:8000/api/competence/${idCompetence}`);
            const data = await response.json();
            if (data && Object.keys(data).length !== 0) {
                console.log(`La compétence avec l'ID ${idCompetence} existe déjà.`);
                return; // Sortir de la fonction si la compétence existe déjà
            }

            // Ajouter la compétence s'elle n'existe pas
            $.ajax({
                url: 'http://localhost:8000/api/addCompetence',
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify([{ label: competenceLabel, id_semestre: idSemestre }]),
                success: function(data) {
                    console.log('Success : ');
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log('Erreur : ' + errorThrown);
                }
			});

        }

        async function ajouterCoefficient(idCoeff, idModule, idCompetence) {
            const response = await fetch(`http://localhost:8000/api/coefficient/${idCoeff}`);
            const data = await response.json();
            if (data && Object.keys(data).length !== 0) {
                console.log(`Le coefficient avec l'ID ${idCoeff} existe déjà.`);
                return;
            }

            $.ajax({
				url: 'http://localhost:8000/api/addCoefficient',
				type: 'POST',
				dataType: 'json',
                data: JSON.stringify([{ id_module: idModule, id_comp: idCompetence, coef: 1 }]),
				success: function(data) {
					console.log('Success Coefficient : ');
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log('Erreur : ' + errorThrown);
				}
            });

        }


        async function getMaxModuleId() {
            const responseModule = await fetch('http://localhost:8000/api/module');
            const modules = await responseModule.json();

            if (modules.length === 0) {
                return 0;
            }

            const maxId = modules.reduce((max, module) => {
                return Math.max(max, module.id_module);
            }, modules[0].id_module);

            return maxId;
        }

        async function getMaxCompetenceId() {
            const responseCompetence = await fetch('http://localhost:8000/api/competence');
            const competences = await responseCompetence.json();

            if (competences.length === 0) {
                return 0;
            }

            const maxId = competences.reduce((max, competence) => {
                return Math.max(max, competence.id_comp);
            }, competences[0].id_comp);

            return maxId;
        }

        async function getMaxCoeffId() {
            const responseCoefficient = await fetch('http://localhost:8000/api/coefficient');
            const coefficients = await responseCoefficient.json();

            if (coefficients.length === 0) {
                return 0;
            }

            const maxId = coefficients.reduce((max, coefficient) => {
                return Math.max(max, coefficient.id_coef);
            }, coefficients[0].id_coef);

            return maxId;
        }




        async function getIdCompetenceByName(nomCompetence) {
            const responseCompetence = await fetch('http://localhost:8000/api/competence');
            const competences = await responseCompetence.json();
            const competence = competences.find(c => c.label === nomCompetence);
            if (!competence) {
                console.error('Compétence non trouvée:', nomCompetence);
                return;
            }
            return competence.id;
        }

        async function getIdEtudiantByCode(codeEtudiant) {
            const responseEtudiant = await fetch('http://localhost:8000/api/etudiant');
            const etudiants = await responseEtudiant.json();
            const etudiant = etudiants.find(e => e.code_etu === codeEtudiant);
            if (!etudiant) {
                console.error('Etudiant non trouvée:', codeEtudiant);
                return;
            }
            return etudiant.id;
        }

        async function getIdCoeffByModuleAndComp(idModule, idComp) {
            const responseCoefficient = await fetch('http://localhost:8000/api/coefficient');
            const coefficients = await responseCoefficient.json();
            const coeff = coefficients.find(c => c.id_module === idModule && c.id_comp === idComp);
            if (!coeff) {
                console.error('Coefficient non trouvée: ', idModule, idComp);
                return;
            }
            return coeff.id;
        }

        async function getIdEtudiantByCode(codeEtudiant) {
            try {
                const response = await fetch(`http://localhost:8000/api/etudiantCode/${codeEtudiant}`);
                const data = await response.json();

                if (data && Object.keys(data).length !== 0) {
                    return data.id_etu; // Retourner l'ID de l'étudiant s'il existe
                }
                
                return null; // Retourner null si l'étudiant n'existe pas
            } catch (error) {
                console.error('Une erreur s\'est produite :', error);
                return null; // Retourner null en cas d'erreur
            }
        }


        

    </script>
</body>
</html>
